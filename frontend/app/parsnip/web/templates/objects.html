{# Copyright 2023, Battelle Energy Alliance, LLC, ALL RIGHTS RESERVED #}

{% set years = "2023" %}

{% import 'macros.j2' as macros -%}

{% extends "layout.base" %}

{% block additionalHeader %}
{% endblock additionalHeader %}

{% block content %}
<h2>Parser Objects</h2>
<div class="ui-widget-content">
    <div class="buttonRow">
        <a href="#" class="ui-button ui-widget ui-corner-all addObjectButton">Add Object</a>
    </div>
    <table id="objecsTable" class="infoTable">
        <thead>
            <tr>
                <th scope="col">Name</th>
                <th scope="col">Reference</th>
                <th scope="col">Notes</th>
                <th scope="col">Scope</th>
                <th scope="col">Should Log Independently?</th>
                <th scope="col">Object Dependencies</th>
                <th scope="col">View Fields</th>
                <th scope="col">Delete?</th>
            </tr>
        </thead>
        <tbody>
        {%- if "Structures" in session and "Objects" in session["Structures"] -%}
            {%- for entry in session["Structures"]["Objects"] -%}
            <tr>
                <td id="object{{ loop.index0 }}">{{ entry["name"] }}</td>
                <td>{{ entry["reference"] }}</td>
                <td>{{ entry["notes"] }}</td>
                <td>{{ entry["scope"] }}</td>
                <td>{{ entry["logIndependently"] }}</td>
                <td>
                    <ol>
                    {%- for dependency in entry["dependsOn"] -%}
                        {%- set startString = "" -%}
                        {%- set endString = "" -%}
                        {%- if dependency["referenceType"] -%}
                            {%- set referenceTypeIndex = findStructureItemIndex(dependency["type"], dependency["referenceType"]) -%}
                            {%- if -1 != referenceTypeIndex -%}
                                {%- set urlString = "#" -%}
                                {%- if "object" == dependency["type"] -%}
                                    {%- set urlString = url_for('main.objects') + "#object" + referenceTypeIndex|string -%}
                                {%- elif "enum" == dependency["type"] -%}
                                    {%- set urlString = url_for('main.enums') + "#enum" + referenceTypeIndex|string -%}
                                {%- elif "bits" == dependency["type"] -%}
                                    {%- set urlString = url_for('main.bitfields') + "#bitfield" + referenceTypeIndex|string -%}
                                {%- elif "switch" == dependency["type"] -%}
                                    {%- set urlString = "#" -%}
                                {%- endif -%}
                                {%- set startString = ('<a href="' + urlString + '">')|safe -%}
                                {%- set endString = '</a>'|safe -%}
                            {%- else -%}
                            {%- endif -%}
                        {%- else -%}
                            {%- set endString = dependency["type"] -%}
                            {%- if dependency["size"] -%}
                                {%- set endString = endString + " " + dependency["size"]|string -%}
                            {%- endif -%}
                            {%- set endString = ("<br />(" + endString + ")")|safe -%}
                        {%- endif -%}
                        <li>{{ startString }}{{ dependency["name"] }}{{ endString }}</li>
                    {% endfor %}
                    </ol>
                </td>
                <td class="centeredText"><a href="{{ url_for('main.viewFields', index=loop.index0) }}">View Fields</a></td>
                <td class="centeredText confirmDelete"><a href="{{ url_for('main.removeObject', index=loop.index0) }}">X</a></td>
            </tr>
            {% endfor %}
        {% endif %}
        </tbody>
    </table>
    <div class="buttonRow">
        <a href="#" class="ui-button ui-widget ui-corner-all addObjectButton">Add Object</a>
    </div>
  </div>
</div>

<!-- Dialogs -->
<div id="addObjectDialog" class="dialog" title="Add Object">
    <form method="POST" action="{{ url_for('main.addObject') }}">
        {{ addObjectForm.csrf_token }}
        
        <!-- Name -->
        <p class="fieldSet">
            {{ addObjectForm.objectName.label }}
            {{ addObjectForm.objectName }}
        </p>
        {% if addObjectForm.objectName.error %}
        <div class="ui-widget">
	        <div class="ui-state-error ui-corner-all">
		        <p class="errorLabel"><span class="ui-icon ui-icon-alert"></span>Error:</p>
		        <ul class="errors">
                {% for error in addObjectForm.objectName.error %}
                    <li>{{ error }}</li>
                {% endfor %}
                </ul>
	        </div>
        </div>
        {% endif %}
        <!-- End Name -->
        
        <!-- Reference -->
        <p class="fieldSet">
            {{ addObjectForm.objectReference.label }}
            {{ addObjectForm.objectReference }}
        </p>
        <!-- End Reference -->
        
        <!-- Note -->
        <p class="fieldSet">
            {{ addObjectForm.objectNote.label }}
            {{ addObjectForm.objectNote }}
        </p>
        <!-- End Note -->
        
        <!-- Scope -->
        <p class="fieldSet">
            {{ addObjectForm.objectScope.label }}
            {{ addObjectForm.objectScope }}
        </p>
        {% if addObjectForm.objectScope.error %}
        <div class="ui-widget">
	        <div class="ui-state-error ui-corner-all">
		        <p class="errorLabel"><span class="ui-icon ui-icon-alert"></span>Error:</p>
		        <ul class="errors">
                {% for error in addObjectForm.objectScope.error %}
                    <li>{{ error }}</li>
                {% endfor %}
                </ul>
	        </div>
        </div>
        {% endif %}
        <!-- End Scope -->
        
        <!-- Log Independently -->
        <p class="fieldSet">
            {{ addObjectForm.logIndependently.label }}
            {{ addObjectForm.logIndependently }}
        </p>
        <!-- End Log Independently -->
        
        <hr />
        <p id="dependencyLimits">Between {{ addObjectForm.objectDependencies.min_entries }} and {{ addObjectForm.objectDependencies.max_entries }} dependencies may be provided.</p>
        {% set dependenciesText = addObjectForm.objectDependencies|length %}
        {% if dependenciesText != 1 %}
            {% set dependenciesText = dependenciesText|string + " dependencies are" %}
        {% else %}
            {% set dependenciesText = dependenciesText|string + " dependency is" %}
        {% endif %}
        <p id="currentDependencyCount"><span id="DepdendencyCounterSpace">{{dependenciesText}}</span> currently defined.</p>
        <!-- Start Additional Dependency List -->
        <div id="dependencies">
        {%- for dependency in addObjectForm.objectDependencies %}
            <p class="fieldSet" id="dependencyFieldSet-{{loop.index0}}">
                <a href="#" id="removeDependency-{{loop.index0}}" onclick="removeDependency({{ loop.index0 }});">X</a>
                {{ dependency.dependencyName.label }}
                {{ dependency.dependencyName }}<br />
                {{ dependency.dependencyType.label }}
                {{ dependency.dependencyType(onchange="updateDependencyType(" + loop.index0|string  + ")") }}<br />
                {{ dependency.fieldSize.label }}
                {{ dependency.fieldSize }}<br />
                {{ dependency.referenceType.label }}
                {{ dependency.referenceType }}
            </p>
        {% endfor -%}
        </div>
        <!-- End Additional Dependency List -->
        <a href="#" class="ui-button ui-widget ui-corner-all" onclick="addDependency();">Add Dependency</a>
        <hr />
        <input type="submit" value="Add Object" class="ui-button ui-widget ui-corner-all" />
    </form>
</div>
{% endblock content %}

{% block additionalJavascript %}
<script>
function updateDependencyElements(typeID, sizeID, referenceID) {
    fieldType = $('#' + typeID).val();
    
    if("object" == fieldType || "enum" == fieldType)
    {
        $('#' + referenceID).prop("disabled", false);
        $('#' + referenceID).show();
        $('#' + referenceID).labels().show();
        $('#' + sizeID).prop("disabled", true);
        $('#' + sizeID).hide();
        $('#' + sizeID).labels().hide();
    }
    else // built in or custom type
    {
        $('#' + referenceID).prop("disabled", true);
        $('#' + referenceID).hide();
        $('#' + referenceID).labels().hide();
        $('#' + sizeID).prop("disabled", false);
        $('#' + sizeID).show();
        $('#' + sizeID).labels().show();
    }
}

function updateDependencyType(index) {
    updateDependencyElements('objectDependencies-' + index + '-dependencyType',
                             'objectDependencies-' + index + '-fieldSize',
                             'objectDependencies-' + index + '-referenceType');
}


function updateDependenciesCount() {
    text = currentDependencies;
    if(1 == text)
    {
        text = text + " dependency is";
    }
    else
    {
        text = text + " dependencies are";
    }
    $("#DepdendencyCounterSpace").html(text);
}

function addDependency() {
    currentHTML = $("#dependencies").html();
    
    currentNameValues = $("#dependencies [id$='dependencyName']")
    currentTypeValues = $("#dependencies [id$='dependencyType']")
    currentSizeValues = $("#dependencies [id$='fieldSize']")
    currentReferenceTypeValues = $("#dependencies [id$='referenceType']")
    
    dependencyNameID = "objectDependencies-" + nextDependenciesIndex + "-dependencyName";
    dependencyTypeID = "objectDependencies-" + nextDependenciesIndex + "-dependencyType";
    dependencySizeID = "objectDependencies-" + nextDependenciesIndex + "-fieldSize";
    dependencyReferenceTypeID = "objectDependencies-" + nextDependenciesIndex + "-referenceType";
    
    currentHTML += "\n<p class=\"fieldSet\" id=\"dependencyFieldSet-" + nextDependenciesIndex + "\">";
    currentHTML += "<a href=\"#\" id=\"removeDependency-" + nextDependenciesIndex + "\" onclick=\"removeDependency(" + nextDependenciesIndex + ");\">X</a>\n";
    currentHTML += "<label for=\"" + dependencyNameID + "\">Dependency Name: </label>";
    currentHTML += "<input id=\"" + dependencyNameID + "\" name=\"" + dependencyNameID + "\" required type=\"text\"><br />";
    currentHTML += "<label for=\"" + dependencyTypeID + "\">Dependency Type: </label>";
    currentHTML += "<select id=\"" + dependencyTypeID + "\" name=\"" + dependencyTypeID + "\" onchange=\"updateDependencyType(" + nextDependenciesIndex + ")\">";
    {% for item in dependencyTypes -%}
    currentHTML += "<option value='{{ item[0] }}'>{{ item[1] }}</option>";
    {% endfor -%}
    currentHTML += "</select><br />";
    currentHTML += "<label for=\"" + dependencySizeID + "\">Field Size (Bits): </label>";
    currentHTML += "<input id=\"" + dependencySizeID + "\" name=\"" + dependencySizeID + "\" type=\"number\" min=\"0\"><br />";
    currentHTML += "<label for=\""+ dependencyReferenceTypeID + "\">Reference Type: </label>";
    currentHTML += "<select id=\"" + dependencyReferenceTypeID + "\" name=\"" + dependencyReferenceTypeID + "\">";
    {% for item in enumReferences -%}
    currentHTML += "<option value='{{ item[0] }}'>{{ item[1] }}</option>";
    {% endfor -%}
    currentHTML += "</select><br />";
    currentHTML += "</p>\n"
    $("#dependencies").html(currentHTML);
    updateDependencyType(nextDependenciesIndex);
    
    ++currentDependencies;
    ++nextDependenciesIndex;
    updateDependenciesCount();
    
    currentNameValues.each(function(){
        currentID = $(this).attr("id");
        currentValue = $(this).val();
        $("#dependencies #" + currentID).val(currentValue);
    });
    
    currentTypeValues.each(function(){
        currentID = $(this).attr("id");
        currentValue = $(this).val();
        $("#dependencies #" + currentID).val(currentValue);
    });
    
    currentSizeValues.each(function(){
        currentID = $(this).attr("id");
        currentValue = $(this).val();
        $("#dependencies #" + currentID).val(currentValue);
    });
    
    currentReferenceTypeValues.each(function(){
        currentID = $(this).attr("id");
        currentValue = $(this).val();
        $("#dependencies #" + currentID).val(currentValue);
    });
}

function removeDependency(fieldNumber) {
    $("#dependencyFieldSet-" + fieldNumber).remove();
    --currentDependencies;
    updateDependenciesCount();
}

const maxDependencies = {{ addObjectForm.objectDependencies.max_entries }};
var currentDependencies = {{ addObjectForm.objectDependencies | length }};
var nextDependenciesIndex = {{ addObjectForm.objectDependencies | length }};

$(function() {
	
	const buttonsAndDialogs = ["addObject"];

	for(let i = 0; i < buttonsAndDialogs.length; ++i)
	{
	    let value = buttonsAndDialogs[i];
        $('#' + value + 'Dialog').dialog(dialogInitializationValue);
        $('.' + value + 'Button').click(function(event) {
            loadForm(event, value + 'Dialog');
        });
	}
	
	$(".confirmDelete").click(function(){
        return confirm("Are you sure you want to delete?");
    })
    
    for(let i = 0; i < {{ addObjectForm.objectDependencies|length }}; ++i)
    {
        updateDependencyType(i);
    }
});
</script>
{% endblock additionalJavascript %}
